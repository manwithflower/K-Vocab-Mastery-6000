<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Vocab Master Pro v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-tab { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const App = () => {
            const [allWords, setAllWords] = useState([]);
            const [learnedIds, setLearnedIds] = useState(new Set());
            const [loading, setLoading] = useState(true);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            
            const [selectedLevel, setSelectedLevel] = useState("A"); 
            const [indexTab, setIndexTab] = useState("KOR"); 
            const [selectedChar, setSelectedChar] = useState("ㄱ");

            const consonants = ["ㄱ","ㄴ","ㄷ","ㄹ","ㅁ","ㅂ","ㅅ","ㅇ","ㅈ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
            const alphabets = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

            useEffect(() => {
                fetch('./word_data_translated.json')
                    .then(res => res.json())
                    .then(data => {
                        setAllWords(data);
                        const saved = localStorage.getItem('k_vocab_learned');
                        if (saved) setLearnedIds(new Set(JSON.parse(saved)));
                        setLoading(false);
                    })
                    .catch(err => console.error("Data load error:", err));
            }, []);

            // [핵심 수정] 한국어 초성 추출 및 겹자음 통합 로직
            const getInitialConsonant = (str) => {
                const charCode = str.charCodeAt(0) - 0xAC00;
                if (charCode < 0 || charCode > 11171) return str[0].toUpperCase();
                
                // 0:ㄱ, 1:ㄲ, 2:ㄴ, 3:ㄷ, 4:ㄸ, 5:ㄹ, 6:ㅁ, 7:ㅂ, 8:ㅃ, 9:ㅅ, 10:ㅆ, 11:ㅇ, 12:ㅈ, 13:ㅉ, 14:ㅊ, 15:ㅋ, 16:ㅌ, 17:ㅍ, 18:ㅎ
                const initialIdx = Math.floor(charCode / 588);
                
                // 겹자음을 기본 자음 인덱스로 매핑 (ㄲ->ㄱ, ㄸ->ㄷ, ㅃ->ㅂ, ㅆ->ㅅ, ㅉ->ㅈ)
                const mapping = { 1: 0, 4: 3, 8: 7, 10: 9, 13: 12 };
                const finalIdx = mapping[initialIdx] !== undefined ? mapping[initialIdx] : initialIdx;
                
                // 14개 기본 자음 배열에서 추출 (ㅊ 이후는 인덱스 조정)
                const consonantMap = ["ㄱ","ㄱ","ㄴ","ㄷ","ㄷ","ㄹ","ㅁ","ㅂ","ㅂ","ㅅ","ㅅ","ㅇ","ㅈ","ㅈ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
                return consonantMap[initialIdx] || str[0].toUpperCase();
            };

            const speak = (text, lang) => {
                window.speechSynthesis.cancel();
                const uttr = new SpeechSynthesisUtterance(text);
                uttr.lang = lang === 'ko' ? 'ko-KR' : 'en-US';
                uttr.rate = 0.9;
                window.speechSynthesis.speak(uttr);
            };

            const levelFiltered = useMemo(() => {
                return allWords.filter(w => w.level_label.includes(selectedLevel));
            }, [allWords, selectedLevel]);

            // [핵심 수정] 인덱스 리스트 필터링 및 가나다순 정렬
            const indexList = useMemo(() => {
                return levelFiltered
                    .filter(w => {
                        if (indexTab === "KOR") return getInitialConsonant(w.word) === selectedChar;
                        const firstLetterEn = (w.definition_en || "").trim()[0];
                        return (firstLetterEn || "").toUpperCase() === selectedChar;
                    })
                    .sort((a, b) => a.word.localeCompare(b.word, 'ko'));
            }, [levelFiltered, indexTab, selectedChar]);

            const currentWord = levelFiltered[currentIndex];
            
            const levelProgress = useMemo(() => {
                if (levelFiltered.length === 0) return 0;
                const learnedInLevel = levelFiltered.filter(w => learnedIds.has(w.id)).length;
                return ((learnedInLevel / levelFiltered.length) * 100).toFixed(1);
            }, [levelFiltered, learnedIds]);

            const toggleLearned = (id) => {
                const newLearned = new Set(learnedIds);
                if (newLearned.has(id)) newLearned.delete(id);
                else newLearned.add(id);
                setLearnedIds(newLearned);
                localStorage.setItem('k_vocab_learned', JSON.stringify([...newLearned]));
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-bold">학습 데이터를 준비 중입니다...</div>;

            return (
                <div className="max-w-xl mx-auto min-h-screen bg-slate-50 flex flex-col shadow-2xl">
                    <header className="p-6 bg-white border-b sticky top-0 z-20">
                        <div className="flex justify-between items-center mb-4">
                            <div>
                                <h1 className="text-xl font-black text-slate-800">Level {selectedLevel} 학습</h1>
                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Level Progress</p>
                            </div>
                            <div className="text-right">
                                <span className="text-2xl font-black text-blue-600">{levelProgress}%</span>
                            </div>
                        </div>
                        <div className="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden mb-6">
                            <div className="bg-blue-500 h-full transition-all duration-700" style={{width: `${levelProgress}%`}}></div>
                        </div>
                        <div className="flex gap-2">
                            {["A (초급)", "B (중급)", "C (고급)"].map(lvl => (
                                <button key={lvl} onClick={() => {setSelectedLevel(lvl[0]); setCurrentIndex(0); setIsFlipped(false);}}
                                    className={`flex-1 py-3 rounded-xl font-bold text-xs transition-all ${selectedLevel === lvl[0] ? 'bg-blue-600 text-white shadow-md scale-[1.02]' : 'bg-white text-slate-400 border border-slate-100'}`}
                                >{lvl}</button>
                            ))}
                        </div>
                    </header>

                    <div className="bg-white px-4 border-b">
                        <div className="flex border-b text-[11px] font-bold text-slate-400">
                            <button onClick={() => {setIndexTab("KOR"); setSelectedChar("ㄱ");}} className={`flex-1 py-3 ${indexTab === "KOR" ? 'active-tab' : ''}`}>ㄱ-ㅎ 통합색인</button>
                            <button onClick={() => {setIndexTab("ENG"); setSelectedChar("A");}} className={`flex-1 py-3 ${indexTab === "ENG" ? 'active-tab' : ''}`}>A-Z English</button>
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar py-4">
                            {(indexTab === "KOR" ? consonants : alphabets).map(char => (
                                <button key={char} onClick={() => setSelectedChar(char)}
                                    className={`min-w-[44px] h-11 rounded-xl flex items-center justify-center font-bold transition-all ${selectedChar === char ? 'bg-slate-800 text-white shadow-lg' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}`}
                                >{char}</button>
                            ))}
                        </div>
                    </div>

                    <main className="p-6 flex-1 flex flex-col justify-center">
                        {currentWord ? (
                            <div className="animate-fadeIn">
                                <div className={`h-80 bg-white rounded-[3rem] shadow-xl flex flex-col items-center justify-center p-10 cursor-pointer transition-all active:scale-95 border-b-[6px] border-slate-200 ${learnedIds.has(currentWord.id) ? 'ring-4 ring-green-400 ring-offset-4' : ''}`}
                                    onClick={() => {
                                        setIsFlipped(!isFlipped);
                                        if(!isFlipped) speak(currentWord.definition_en, 'en');
                                        else speak(currentWord.word, 'ko');
                                    }}
                                >
                                    {!isFlipped ? (
                                        <div className="text-center">
                                            <p className="text-xs font-bold text-blue-400 mb-3 uppercase tracking-[0.2em]">{currentWord.pos}</p>
                                            <h2 className="text-6xl font-black text-slate-800 mb-4 tracking-tighter">{currentWord.word}</h2>
                                            <p className="text-slate-300 text-[10px] font-bold uppercase tracking-widest">Tap to flip</p>
                                        </div>
                                    ) : (
                                        <div className="text-center px-4">
                                            <h2 className="text-4xl font-bold text-blue-600 leading-tight">{currentWord.definition_en}</h2>
                                        </div>
                                    )}
                                </div>

                                <div className="mt-10 grid grid-cols-2 gap-4">
                                    <button onClick={() => toggleLearned(currentWord.id)}
                                        className={`py-4 rounded-2xl font-black text-sm shadow-md transition-all ${learnedIds.has(currentWord.id) ? 'bg-green-500 text-white' : 'bg-white text-slate-800 border-2 border-slate-100'}`}
                                    >
                                        {learnedIds.has(currentWord.id) ? "LEARNED ✅" : "외웠어요!"}
                                    </button>
                                    <button onClick={() => {
                                            const nextIdx = (currentIndex + 1) % levelFiltered.length;
                                            setCurrentIndex(nextIdx);
                                            setIsFlipped(false);
                                            speak(levelFiltered[nextIdx].word, 'ko');
                                        }}
                                        className="py-4 bg-slate-800 text-white rounded-2xl font-black text-sm shadow-md active:translate-y-1"
                                    >다음 단어 ➡️</button>
                                </div>
                            </div>
                        ) : (
                            <div className="text-center py-20 text-slate-400 font-bold">해당 조건에 단어가 없습니다.</div>
                        )}
                    </main>

                    <section className="bg-white p-6 rounded-t-[3rem] shadow-[0_-15px_30px_-5px_rgba(0,0,0,0.05)] border-t border-slate-50">
                        <h3 className="font-black text-slate-800 mb-4 flex items-center justify-between px-2">
                            <span className="text-sm">"{selectedChar}" 시작 리스트</span>
                            <span className="text-[10px] bg-blue-50 text-blue-600 px-2.5 py-1 rounded-full font-bold">{indexList.length} WORDS</span>
                        </h3>
                        <div className="grid grid-cols-2 gap-2 max-h-52 overflow-y-auto pr-1 custom-scrollbar">
                            {indexList.map((w) => (
                                <button key={w.id} onClick={() => {
                                        const originalIdx = levelFiltered.findIndex(item => item.id === w.id);
                                        setCurrentIndex(originalIdx);
                                        setIsFlipped(false);
                                        speak(w.word, 'ko');
                                        window.scrollTo({ top: 0, behavior: 'smooth' });
                                    }}
                                    className={`p-4 rounded-2xl text-left text-xs font-bold transition-all border ${currentWord?.id === w.id ? 'bg-blue-600 border-blue-600 text-white shadow-lg' : 'bg-slate-50 border-transparent text-slate-600 hover:bg-slate-100'}`}
                                >
                                    <span className="block truncate">{w.word} {learnedIds.has(w.id) && "✓"}</span>
                                </button>
                            ))}
                        </div>
                    </section>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
